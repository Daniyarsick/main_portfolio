<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр файлов - Портфолио</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <header>
            <a href="#" id="back-btn" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Назад
            </a>
            <h1 id="folder-title">Загрузка...</h1>
            <p class="subtitle" id="folder-subtitle">Список файлов</p>
        </header>

        <main class="file-grid" id="file-list">
            <!-- Files will be injected here -->
        </main>
    </div>

    <script src="files.js"></script>
    <script>
        const GITHUB_OWNER = 'Daniyarsick';
        const GITHUB_REPO = 'main_portfolio';
        const GITHUB_BRANCH = 'main';

        function encodePathSegments(path) {
            return String(path)
                .split('/')
                .filter(Boolean)
                .map(seg => encodeURIComponent(seg))
                .join('/');
        }

        // Относительный путь для GitHub Pages (с правильным URL-encoding)
        function toPagesHref(repoPath) {
            return './' + encodePathSegments(repoPath);
        }

        // GitHub Blob viewer (лучше для PDF/LFS и крупных файлов)
        function toGitHubBlobHref(repoPath) {
            return `https://github.com/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/blob/${encodeURIComponent(GITHUB_BRANCH)}/${encodePathSegments(repoPath)}`;
        }

        function getFileType(filename) {
            const idx = filename.lastIndexOf('.');
            if (idx === -1) return 'file';
            return filename.slice(idx + 1).toLowerCase();
        }

        async function githubFetchJson(pathnameWithQuery) {
            const url = `https://api.github.com${pathnameWithQuery}`;
            const response = await fetch(url, {
                headers: {
                    'Accept': 'application/vnd.github+json'
                }
            });

            if (!response.ok) {
                const text = await response.text().catch(() => '');
                throw new Error(`GitHub API error ${response.status}: ${text || response.statusText}`);
            }

            return response.json();
        }

        async function githubListContents(repoPath) {
            const encoded = encodePathSegments(repoPath);
            return githubFetchJson(`/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/contents/${encoded}?ref=${encodeURIComponent(GITHUB_BRANCH)}`);
        }

        async function listFilesRecursively(rootRepoPath) {
            const files = [];
            const dirs = [rootRepoPath];
            const concurrency = 4;

            while (dirs.length > 0) {
                const batch = dirs.splice(0, concurrency);
                const results = await Promise.all(batch.map(async (dirPath) => ({
                    dirPath,
                    entries: await githubListContents(dirPath)
                })));

                for (const { entries } of results) {
                    if (!Array.isArray(entries)) continue;
                    for (const entry of entries) {
                        if (!entry || typeof entry !== 'object') continue;

                        if (entry.type === 'dir' && entry.path) {
                            dirs.push(entry.path);
                        } else if (entry.type === 'file' && entry.path) {
                            files.push({
                                name: entry.name || entry.path.split('/').pop(),
                                repoPath: entry.path,
                                type: getFileType(entry.name || entry.path),
                                size: typeof entry.size === 'number' ? entry.size : 0
                            });
                        }
                    }
                }
            }

            return files;
        }

        function iconForType(type) {
            if (['jpg', 'png', 'jpeg', 'gif', 'svg'].includes(type)) return 'fa-file-image';
            if (type === 'pdf') return 'fa-file-pdf';
            if (['doc', 'docx'].includes(type)) return 'fa-file-word';
            if (['xls', 'xlsx'].includes(type)) return 'fa-file-excel';
            if (['ppt', 'pptx'].includes(type)) return 'fa-file-powerpoint';
            if (['zip', 'rar', '7z'].includes(type)) return 'fa-file-archive';
            if (['mp4', 'avi', 'mkv', 'mov'].includes(type)) return 'fa-file-video';
            if (['mp3', 'wav', 'ogg'].includes(type)) return 'fa-file-audio';
            if (['py', 'js', 'html', 'css', 'cpp', 'java', 'c', 'h'].includes(type)) return 'fa-file-code';
            if (['txt', 'md'].includes(type)) return 'fa-file-alt';
            return 'fa-file';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const pathParam = params.get('path'); // e.g., "1 курс/Дискретная математика"

            if (!pathParam) {
                document.getElementById('folder-title').textContent = "Ошибка: Путь не указан";
                return;
            }

            const parts = pathParam.split('/');
            const course = parts[0];
            const subject = parts[1];

            document.getElementById('folder-title').textContent = subject || course;
            document.getElementById('folder-subtitle').textContent = pathParam;

            // Set back button
            const backBtn = document.getElementById('back-btn');
            if (course === "1 курс") backBtn.href = "course1.html";
            else if (course === "2 курс") backBtn.href = "course2.html";
            else if (course === "3 курс") backBtn.href = "course3.html";
            else if (course === "4 курс") backBtn.href = "course4.html";
            else backBtn.href = "index.html";

            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '<p class="empty-msg">Загрузка…</p>';

            let files = [];
            try {
                files = await listFilesRecursively(pathParam);
            } catch (error) {
                // Fallback to pre-generated index if present
                if (typeof fileData !== 'undefined' && fileData[course] && fileData[course][subject]) {
                    files = fileData[course][subject].map(f => ({
                        name: f.name,
                        repoPath: String(f.path || '').startsWith('./') ? String(f.path).slice(2) : String(f.path),
                        type: f.type,
                        size: f.size
                    }));
                } else {
                    fileList.innerHTML = '<p class="empty-msg">Не удалось загрузить файлы</p>';
                    // eslint-disable-next-line no-console
                    console.error(error);
                    return;
                }
            }

            if (!files || files.length === 0) {
                fileList.innerHTML = '<p class="empty-msg">Папка пуста</p>';
                return;
            }

            // Sort: PDFs first, then others
            files.sort((a, b) => {
                if (a.type === 'pdf' && b.type !== 'pdf') return -1;
                if (a.type !== 'pdf' && b.type === 'pdf') return 1;
                return String(a.name).localeCompare(String(b.name), 'ru');
            });

            fileList.innerHTML = '';

            files.forEach(file => {
                const fileCard = document.createElement('a');
                const fileType = file.type || getFileType(file.name);
                const fileSize = typeof file.size === 'number' ? file.size : 0;

                // PDF и большие файлы открываем через GitHub (из-за LFS/ограничений Pages)
                if (fileType === 'pdf') {
                    fileCard.href = toGitHubBlobHref(file.repoPath);
                } else if (['mp4', 'avi', 'mp3'].includes(fileType) && fileSize > 50000000) {
                    fileCard.href = toGitHubBlobHref(file.repoPath);
                } else {
                    fileCard.href = toPagesHref(file.repoPath);
                }

                fileCard.className = 'file-card';
                fileCard.target = '_blank';

                const iconClass = iconForType(fileType);
                fileCard.innerHTML = `
                    <div class="file-icon"><i class="fas ${iconClass}"></i></div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatSize(fileSize)}</div>
                    </div>
                `;
                fileList.appendChild(fileCard);
            });
        });

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>

</html>